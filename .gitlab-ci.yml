## Global variables
variables:
  GIT_DEPTH: 1

## Global defaults
default:
  image: gitlab-executor:latest
  tags:
    - local-docker-runner

## Global stages
stages:
  - setup
  # - build
  # - test
  - deploy

## Caches
.node-cache: &node-cache
  key: node-cache-$CI_COMMIT_REF_SLUG
  paths:
    - node_modules/
    - .nx/
  policy: pull

.forge-cache: &forge-cache
  key: forge-cache-$CI_COMMIT_REF_SLUG
  paths:
    - packages/contract/lib/
  policy: pull

## Jobs
setup:
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  cache:
    - <<: *node-cache
      policy: push
    - <<: *forge-cache
      policy: push
  stage: setup
  script:
    - npm install

# contract-build:
#   cache:
#     - <<: *node-cache
#     - <<: *forge-cache
#   stage: build
#   needs: [setup]
#   dependencies:
#     - setup
#   script:
#     - npx nx build contract

# frontend-build:
#   cache:
#   cache:
#     - <<: *node-cache
#   stage: build
#   needs: [setup]
#   dependencies:
#     - setup
#   script:
#     - npx nx build frontend

# contract-test:
#   cache:
#     - <<: *node-cache
#     - <<: *forge-cache
#   stage: test
#   needs: [setup]
#   dependencies:
#     - setup
#   script:
#     - npx nx test contract --fork-url \"https://lb.drpc.org/ogrpc?network=ethereum&dkey=AsidPtsErUyZubtI9TsBlxmnRdP2jvcR7rqTHqSlA2KD\" -vvvv

contract-deploy:
  cache:
    - <<: *node-cache
    - <<: *forge-cache
  stage: deploy
  needs: [setup]
  dependencies:
    - setup
  script:
    - npx nx deploy contract
    - cat deploy_info.txt | head -n 1 | jq '.deployedTo'
