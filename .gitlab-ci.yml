## Global variables
variables:
  GIT_DEPTH: 1
  DEPLOY_RPC: "https://lb.drpc.org/ogrpc?network=polygon-mumbai&dkey=AmvHqebJ6k7ThQWeGwnLVmnsDTC3hx0R7qTGrkUU-y5L"
  UNISWAP_NF_POSITION_MANAGER_ADDR: 0xC36442b4a4522E871399CD717aBDD847Ab11FE88
  UNISWAP_FACTORY_ADDR: 0x1F98431c8aD98523631AE4a59f267346ea31F984
  ETHERSCAN_API_KEY: "R93KQB2UG493H148YUSDFQH9498RV9AJIJ"
  

## Global defaults
default:
  image: gitlab-executor:latest
  tags:
    - local-docker-runner

## Global stages
stages:
  - setup
  - build
  - test
  - deploy

## Caches
.node-cache: &node-cache
    key: node-cache-$CI_COMMIT_REF_SLUG
    paths:
      - node_modules/
      - .nx/
    policy: pull

.forge-cache: &forge-cache
    key: forge-cache-$CI_COMMIT_REF_SLUG
    paths:
        - packages/contract/lib/
    policy: pull

## Jobs
setup:
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  cache:
      - <<: *node-cache
        policy: push
      - <<: *forge-cache
        policy: push
  stage: setup
  script:
    - npm install

contract-build:
  cache:
    - <<: *node-cache
    - <<: *forge-cache
  stage: build
  needs: [setup]
  dependencies:
    - setup
  script:
    - npx nx build contract

frontend-build:
  cache:
  cache:
    - <<: *node-cache
  stage: build
  needs: [setup]
  dependencies:
    - setup
  script:
    - npx nx build frontend

contract-test:
  cache:
    - <<: *node-cache
    - <<: *forge-cache
  stage: test
  needs: [setup]
  dependencies:
    - setup
  script:
    - npx nx test4 contract

contract-deploy:
  cache:
    - <<: *node-cache
    - <<: *forge-cache
  stage: test
  needs: [setup]
  dependencies:
    - setup
  script:
    - |-
        forge create \
        --rpc-url '${DEPLOY_RPC}' \
        --private-key '${TEST_EOA_PRIVATE_KEY}' \
        --constructor-args ${UNISWAP_NF_POSITION_MANAGER_ADDR} ${UNISWAP_FACTORY_ADDR} \
        --verify \
        --legacy \
        --etherscan-api-key '${ETHERSCAN_API_KEY}' \
        src/PositionManager.sol:PositionManager